cmake_minimum_required(VERSION 3.14)

project(jknative LANGUAGES C CXX)

set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

message(STATUS "Building for X86_64 architecture")

# X86_64 simplified configuration - no LVGL, no Rockchip dependencies
find_package(PkgConfig REQUIRED)

# Try to find system libraries (optional)
pkg_check_modules(DRM libdrm)

# Get source files for X86_64 - use mock implementation
set(sources
    ${CMAKE_CURRENT_SOURCE_DIR}/ctrl_x86_64.c
    ${CMAKE_CURRENT_SOURCE_DIR}/ui_index.c
)

# Create a minimal library with mock implementations
add_library(jknative STATIC ${sources} ${CMAKE_CURRENT_SOURCE_DIR}/ctrl.h)

# Include directories
target_include_directories(jknative PRIVATE
    ${CMAKE_CURRENT_SOURCE_DIR}
    /usr/include/libdrm  # System libdrm headers
)

if(DRM_FOUND)
    target_include_directories(jknative PRIVATE ${DRM_INCLUDE_DIRS})
endif()

# Link libraries - minimal set for X86_64
target_link_libraries(jknative PRIVATE
    pthread
    m
    dl  # For dynamic loading
)

if(DRM_FOUND)
    target_link_libraries(jknative PRIVATE ${DRM_LIBRARIES})
endif()

# Add compiler definitions for X86_64 build
target_compile_definitions(jknative PRIVATE
    TARGET_ARCH_X86_64=1
    NO_LVGL=1
    NO_ROCKCHIP=1
)

# Install library
install(TARGETS jknative DESTINATION lib)

# Install headers - create minimal header set for X86_64
install(FILES 
    ${CMAKE_CURRENT_SOURCE_DIR}/ctrl.h
    DESTINATION include
)

# Create a minimal ui_index.h for installation
file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/ui_index.h
"#ifndef UI_INDEX_H
#define UI_INDEX_H

// Mock UI index header for X86_64
typedef struct {
    const char *name;
    void **obj;
} ui_obj_map;

extern ui_obj_map ui_objects[];
extern const int ui_objects_size;

typedef struct {
    const char *name;
    void *(*getter)();
} ui_style_map;

extern ui_style_map ui_styles[];
extern const int ui_styles_size;

typedef struct {
    const char *name;
    const void *img;
} ui_img_map;

extern ui_img_map ui_images[];
extern const int ui_images_size;

typedef struct {
    const char *name;
    const char *(*getter)();
    void (*setter)(const char *value);
} ui_var_map;

extern ui_var_map ui_vars[];
extern const int ui_vars_size;

#endif // UI_INDEX_H
")

install(FILES 
    ${CMAKE_CURRENT_BINARY_DIR}/ui_index.h
    DESTINATION include
)